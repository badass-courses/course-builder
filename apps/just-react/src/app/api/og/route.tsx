// EXAMPLE USAGE
// with resource: /api/og?resource=[SLUG_OR_ID]
// with custom title: /api/og?title=ANYTHING

import { ImageResponse } from 'next/og'
import { db } from '@/db'
import { contentResource, contentResourceResource, products } from '@/db/schema'
import { getVideoResourceForLesson } from '@/lib/lessons-query'
import { generateGridPattern } from '@/utils/generate-grid-pattern'
import { PlayIcon } from '@heroicons/react/24/solid'
import { and, asc, eq, or, sql } from 'drizzle-orm'

export const runtime = 'edge'
export const revalidate = 60
// export const contentType = 'image/png'

export async function GET(request: Request) {
	try {
		const { searchParams } = new URL(request.url)
		const resourceTypesWithImages = [
			'post',
			'list',
			'workshop',
			'tutorial',
			'self-paced',
		]
		const hasResource = searchParams.has('resource')
		const resourceSlugOrID = hasResource ? searchParams.get('resource') : null
		const hasTitle = searchParams.has('title')
		const hasImage = searchParams.has('image')
		let title
		let image = hasImage ? searchParams.get('image') : null
		let muxPlaybackId
		let resource

		if (resourceSlugOrID && !hasTitle) {
			resource = await db.query.contentResource.findFirst({
				extras: {
					fields:
						sql<string>`JSON_REMOVE(${contentResource.fields}, '$.body')`.as(
							'fields',
						),
				},
				where: and(
					or(
						eq(
							sql`JSON_EXTRACT (${contentResource.fields}, "$.slug")`,
							resourceSlugOrID,
						),
						eq(contentResource.id, resourceSlugOrID),
					),
				),
				with: {
					resources: {
						with: {
							resource: {
								extras: {
									fields:
										sql<string>`JSON_REMOVE(${contentResource.fields}, '$.body', '$.srt', '$.wordLevelSrt', '$.transcript', '$.muxAssetId', '$.originalMediaUrl')`.as(
											'fields',
										),
								},
							},
						},
						orderBy: asc(contentResourceResource.position),
					},
				},
			})

			muxPlaybackId = resource?.resources?.[0]?.resource?.fields?.muxPlaybackId

			let product
			if (!resource) {
				product = await db.query.products.findFirst({
					where: and(
						or(
							eq(
								sql`JSON_EXTRACT (${products.fields}, "$.slug")`,
								resourceSlugOrID,
							),
							eq(products.id, resourceSlugOrID),
						),
					),
				})
			}

			title = resource?.fields?.title || product?.name

			if (resource && resourceTypesWithImages.includes(resource.type)) {
				image =
					resource?.fields?.coverImage?.url ||
					resource.fields?.image ||
					product?.fields?.image?.url ||
					(muxPlaybackId &&
						`https://image.mux.com/${muxPlaybackId}/thumbnail.png?time=${resource?.fields.thumbnailTime || 0}&width=1200`)
			}
		} else {
			if (hasTitle) {
				title = searchParams.get('title')?.slice(0, 100)
			} else {
				title = 'Just React'
			}
		}

		const fontData = await fetch(
			new URL(
				'../../../../public/fonts/79122e33-d8c9-4b2c-8add-f48bd7b317e0.ttf',
				import.meta.url,
			),
		).then((res) => res.arrayBuffer())

		const seed = resourceSlugOrID || title || 'default-seed'

		if (resource?.type === 'cohort' && resource?.fields?.image) {
			return new ImageResponse(
				(
					<img
						src={resource?.fields?.image}
						style={{
							width: 1200,
							height: 630,
						}}
					/>
				),
				{
					width: 1200,
					height: 630,
				},
			)
		}

		return new ImageResponse(
			(
				<div
					tw="flex h-full w-full flex-col"
					style={{
						fontFamily: 'HeadingFont',
						color: '#05118B',
						background: '#F5F3EA',
						width: 1200,
						height: 630,
						backgroundImage:
							resource && resource.type === 'post' && image
								? `url(${image})`
								: '',
						backgroundSize: 'contain',
						backgroundPosition: 'center',
					}}
				>
					{resource && resource.type === 'post' && image && (
						<div tw="absolute right-40 top-26 z-10 flex">
							<svg
								xmlns="http://www.w3.org/2000/svg"
								width={48}
								height={48}
								viewBox="0 0 12 12"
							>
								<g fill="#000">
									<path
										d="M11.741,5.562l-10-5.5a.5.5,0,0,0-.5.008A.5.5,0,0,0,1,.5v11a.5.5,0,0,0,.246.43A.491.491,0,0,0,1.5,12a.5.5,0,0,0,.241-.062l10-5.5a.5.5,0,0,0,0-.876Z"
										fill="#000"
									/>
								</g>
							</svg>
						</div>
					)}
					<div tw="flex items-center justify-center absolute left-26 top-26">
						<svg
							xmlns="http://www.w3.org/2000/svg"
							width="340"
							height="114"
							fill="none"
							viewBox="0 0 340 114"
						>
							<path
								fill="#05118B"
								d="M30.742 56.292c0 4.698-.07 8.198-.208 10.5-.092 2.303-.299 4.1-.621 5.39a16.85 16.85 0 0 1-1.52 3.868c-1.796 2.81-4.214 4.997-7.254 6.563-2.993 1.565-6.148 2.348-9.464 2.348-3.684 0-6.54-.667-8.566-2.003C1.036 81.622 0 79.826 0 77.57c0-1.658.484-2.948 1.45-3.869.922-.921 2.096-1.382 3.524-1.382 1.336 0 2.395.369 3.178 1.106.737.737 1.358 1.796 1.865 3.177.507 1.566 1.06 2.695 1.658 3.385.645.691 1.381 1.037 2.21 1.037 1.474 0 2.672-.945 3.593-2.833.92-1.888 1.381-4.628 1.381-8.22V17.744l-5.872-1.381v-2.556h23.557v2.556l-5.802 1.381v38.548Zm48.538 6.425v1.589L65.188 67.69h-1.52v-4.352l-.207-.208a20.66 20.66 0 0 1-5.596 3.316c-2.073.83-4.099 1.244-6.08 1.244-2.21 0-4.121-.46-5.733-1.382-1.612-.967-2.855-2.349-3.73-4.145-.415-.875-.691-1.934-.83-3.178-.138-1.29-.207-3.5-.207-6.631V34.186l-5.18-1.382v-2.418h15.888v18.929c0 2.487.046 4.33.138 5.527.092 1.15.276 2.072.553 2.763.92 2.533 2.855 3.8 5.803 3.8 1.888 0 3.5-.668 4.835-2.004V34.186l-4.835-1.382v-2.418H74.03v30.397l5.25 1.934Zm17.413-33.021c1.75 0 3.455.115 5.112.345 1.658.184 2.994.46 4.007.829v9.602h-2.694c-.645-4.881-2.947-7.322-6.908-7.322-1.566 0-2.832.391-3.8 1.174-.967.737-1.45 1.727-1.45 2.97 0 1.336.506 2.419 1.52 3.248 1.013.828 2.647 1.796 4.904 2.901 2.165 1.06 3.915 2.05 5.25 2.97 1.382.876 2.557 2.096 3.524 3.662.967 1.566 1.45 3.5 1.45 5.803 0 3.73-1.312 6.632-3.937 8.704-2.625 2.073-6.31 3.109-11.053 3.109a41.03 41.03 0 0 1-5.665-.415c-1.98-.23-3.685-.575-5.112-1.036l-.415-11.26h2.97c.185 2.993.968 5.296 2.35 6.908 1.381 1.566 3.27 2.349 5.664 2.349 1.75 0 3.155-.46 4.214-1.382 1.106-.921 1.658-2.118 1.658-3.592 0-1.474-.552-2.648-1.658-3.523-1.059-.922-2.763-2.004-5.112-3.247-2.118-1.06-3.845-2.027-5.18-2.902-1.336-.92-2.488-2.141-3.455-3.661-.921-1.52-1.382-3.385-1.382-5.596 0-3.5 1.267-6.148 3.8-7.944 2.579-1.796 6.378-2.694 11.398-2.694Zm27.271 37.995c-1.382 0-2.741-.184-4.076-.553-1.29-.322-2.349-.783-3.178-1.382-.967-.736-1.658-1.727-2.073-2.97-.368-1.29-.552-2.925-.552-4.905v-24.04h-4.905l-.414-2.142 13.885-10.57 2.142.346v8.912H135.5l-1.036 3.454h-9.671v21.691c0 1.704.046 2.902.138 3.593.092.69.276 1.243.552 1.658.783 1.29 2.004 1.934 3.662 1.934 1.75 0 3.178-.645 4.283-1.934l1.589 2.28c-1.198 1.52-2.764 2.67-4.698 3.453-1.888.783-4.007 1.175-6.355 1.175Zm32.412-4.767v-45.11l-5.872-1.451v-2.556h24.938c5.573 0 10.04 1.335 13.402 4.007 3.362 2.625 5.043 6.332 5.043 11.122 0 3.316-.829 6.125-2.487 8.428-1.658 2.257-4.053 3.937-7.184 5.043l13.332 20.724 6.287 1.313V67h-18.859L171.09 43.858h-2.832v19.066l7.875 1.52V67h-25.629v-2.556l5.872-1.52Zm12.849-22.797c2.395 0 4.375-.322 5.941-.967 1.566-.645 2.855-1.566 3.868-2.763 1.843-2.119 2.764-4.836 2.764-8.152 0-2.395-.553-4.444-1.658-6.148-1.059-1.704-2.51-2.925-4.352-3.662-1.52-.598-3.547-.898-6.08-.898h-1.45v22.59h.967Zm68.01 6.84h-25.146c.046 4.605.967 8.036 2.763 10.292 1.797 2.211 4.491 3.316 8.083 3.316 2.119 0 4.191-.391 6.217-1.174 2.073-.783 3.754-1.911 5.043-3.385l.484-.553 1.934 1.658-.345.83c-1.244 3.039-3.385 5.434-6.425 7.184-2.993 1.704-6.401 2.556-10.224 2.556-3.776 0-7.115-.76-10.017-2.28-2.855-1.566-5.066-3.73-6.632-6.494-1.566-2.809-2.348-6.033-2.348-9.671 0-3.823.875-7.208 2.625-10.155 1.75-2.994 4.191-5.297 7.322-6.908 3.132-1.658 6.724-2.487 10.777-2.487 5.25 0 9.257 1.427 12.02 4.283 2.764 2.855 4.237 7.046 4.422 12.573l-.553.414Zm-10.915-3.8c.184-.553.276-1.428.276-2.626 0-2.394-.529-4.213-1.588-5.457-1.06-1.243-2.58-1.865-4.56-1.865-2.349 0-4.237.898-5.665 2.694-1.381 1.796-2.233 4.375-2.556 7.737l14.093-.483Zm22.487 24.524c-2.855 0-5.089-.714-6.701-2.142-1.611-1.474-2.417-3.477-2.417-6.01 0-3.454 1.634-6.217 4.904-8.29 3.27-2.072 8.382-3.592 15.337-4.56v-5.042c0-2.165-.139-3.8-.415-4.905-.23-1.105-.645-1.888-1.243-2.349-.553-.46-1.405-.69-2.556-.69-1.75 0-3.132.437-4.145 1.312-.967.829-1.451 1.957-1.451 3.385 0 .322.046.852.138 1.589.092.645.138 1.128.138 1.45 0 1.29-.46 2.395-1.381 3.317-.921.875-2.05 1.312-3.385 1.312-1.336 0-2.441-.437-3.316-1.312-.829-.876-1.244-2.004-1.244-3.386 0-1.473.484-2.924 1.451-4.352.967-1.427 2.303-2.717 4.007-3.868 3.546-2.303 7.898-3.454 13.056-3.454 4.79 0 7.945 1.151 9.464 3.454.553.875.945 2.026 1.175 3.454.276 1.382.414 3.316.414 5.803v14.23c0 2.027.208 3.5.622 4.422.415.921 1.082 1.382 2.003 1.382 1.06 0 2.073-.553 3.04-1.658l1.589 2.28c-1.474 1.565-3.04 2.74-4.698 3.522-1.612.737-3.408 1.106-5.388 1.106-2.211 0-3.915-.438-5.112-1.313-1.151-.92-1.911-2.302-2.28-4.145h-.276c-3.362 3.639-7.139 5.458-11.33 5.458Zm6.356-6.494c1.934 0 3.523-.668 4.767-2.003v-9.257c-2.257.46-4.007.967-5.251 1.52-1.243.552-2.141 1.243-2.694 2.072-.506.783-.76 1.842-.76 3.178 0 1.52.323 2.648.967 3.385.645.737 1.635 1.105 2.971 1.105Zm40.618 6.494c-3.547 0-6.747-.783-9.603-2.349a17.635 17.635 0 0 1-6.632-6.632c-1.566-2.81-2.349-5.987-2.349-9.533 0-3.73.875-7.07 2.626-10.017 1.75-2.994 4.168-5.32 7.253-6.977 3.132-1.658 6.655-2.487 10.57-2.487 2.763 0 5.25.414 7.461 1.243 2.21.783 3.937 1.888 5.181 3.316 1.289 1.382 1.934 2.924 1.934 4.629 0 1.427-.414 2.556-1.243 3.385-.829.829-1.958 1.243-3.385 1.243-1.566 0-2.672-.414-3.316-1.243-.645-.875-1.06-1.958-1.244-3.247-.23-1.889-.714-3.316-1.451-4.283-.69-.967-1.888-1.451-3.592-1.451-2.901 0-5.158 1.197-6.77 3.592-1.612 2.395-2.418 5.78-2.418 10.155 0 4.422.852 7.784 2.556 10.086 1.75 2.303 4.329 3.454 7.737 3.454 4.191 0 7.6-1.52 10.225-4.56l.483-.552 1.934 1.52-.345.83c-1.382 3.269-3.385 5.733-6.01 7.39-2.625 1.659-5.826 2.488-9.602 2.488Zm32.005 0c-1.382 0-2.741-.184-4.076-.553-1.29-.322-2.349-.783-3.178-1.382-.967-.736-1.658-1.727-2.073-2.97-.368-1.29-.552-2.925-.552-4.905v-24.04h-4.905l-.415-2.142 13.886-10.57 2.142.346v8.912h10.707l-1.036 3.454h-9.671v21.691c0 1.704.046 2.902.138 3.593.092.69.276 1.243.552 1.658.783 1.29 2.004 1.934 3.662 1.934 1.75 0 3.177-.645 4.283-1.934l1.589 2.28c-1.198 1.52-2.764 2.67-4.698 3.453-1.888.783-4.007 1.175-6.355 1.175ZM54.865 106l-5.166-16.957h2.737l3.665 12.983h.177l3.62-12.983h2.783l3.577 12.939h.176L70.1 89.043h2.738L67.671 106h-2.562L61.4 92.974h-.265L57.426 106h-2.561Zm20.173 0V89.043h2.605V106h-2.605Zm1.325-19.783c-.508 0-.946-.173-1.314-.519a1.667 1.667 0 0 1-.541-1.247c0-.486.18-.901.54-1.247a1.852 1.852 0 0 1 1.315-.52c.507 0 .942.174 1.302.52.368.346.552.761.552 1.247 0 .486-.184.902-.552 1.248-.36.345-.795.518-1.302.518Zm12.183 2.826v2.208h-8.788v-2.208h8.788Zm-6.226-4.062h2.605v16.162c0 .736.107 1.288.32 1.656.22.36.5.603.839.728.346.118.71.177 1.093.177.287 0 .522-.015.706-.044l.442-.089.53 2.341a5.32 5.32 0 0 1-.74.198c-.316.074-.717.111-1.203.111a5.236 5.236 0 0 1-2.164-.475 4.292 4.292 0 0 1-1.744-1.446c-.456-.648-.684-1.465-.684-2.451V84.981ZM94.19 95.8V106h-2.604V83.391h2.605v8.302h.22a4.792 4.792 0 0 1 1.79-2.087c.801-.522 1.868-.783 3.2-.783 1.156 0 2.168.232 3.036.695.869.457 1.542 1.16 2.021 2.109.485.942.728 2.141.728 3.599V106h-2.605V95.402c0-1.347-.35-2.388-1.049-3.124-.692-.743-1.652-1.115-2.881-1.115-.854 0-1.62.18-2.296.541-.67.36-1.2.887-1.59 1.579-.383.691-.574 1.53-.574 2.517Zm29.35 10.2h-6.977V83.391h7.286c2.193 0 4.07.453 5.63 1.358 1.56.898 2.756 2.19 3.588 3.875.831 1.678 1.247 3.687 1.247 6.028 0 2.355-.419 4.382-1.258 6.082-.839 1.693-2.061 2.996-3.665 3.908-1.605.905-3.555 1.358-5.851 1.358Zm-4.239-2.429h4.062c1.87 0 3.419-.36 4.648-1.082 1.229-.721 2.145-1.747 2.749-3.08.603-1.332.905-2.918.905-4.758 0-1.825-.298-3.396-.894-4.713-.597-1.325-1.487-2.34-2.672-3.047-1.185-.714-2.66-1.071-4.427-1.071H119.3v17.751Zm22.999 2.826c-1.075 0-2.05-.202-2.926-.607a5.013 5.013 0 0 1-2.086-1.777c-.515-.78-.773-1.722-.773-2.826 0-.972.191-1.76.574-2.363a4.05 4.05 0 0 1 1.535-1.435 8.055 8.055 0 0 1 2.119-.772c.78-.177 1.564-.317 2.352-.42a101.66 101.66 0 0 1 2.506-.298c.647-.074 1.118-.195 1.413-.364.301-.17.452-.464.452-.883v-.089c0-1.089-.298-1.935-.894-2.539-.589-.603-1.483-.905-2.683-.905-1.243 0-2.219.272-2.925.817-.707.544-1.203 1.126-1.49 1.744L137 92.797c.441-1.03 1.03-1.833 1.766-2.407a6.616 6.616 0 0 1 2.429-1.214 10.075 10.075 0 0 1 2.605-.353c.545 0 1.17.066 1.877.198a6 6 0 0 1 2.064.784c.67.398 1.226.997 1.667 1.8.442.802.662 1.876.662 3.223V106h-2.605v-2.296h-.132c-.177.368-.471.762-.883 1.181-.413.42-.961.776-1.645 1.071-.685.294-1.52.441-2.506.441Zm.397-2.34c1.03 0 1.899-.202 2.605-.607.714-.405 1.252-.927 1.612-1.568.368-.64.552-1.313.552-2.02v-2.384c-.11.132-.353.254-.728.364-.368.103-.795.195-1.281.276-.478.074-.946.14-1.402.199-.449.051-.813.095-1.093.132a9.968 9.968 0 0 0-1.899.43c-.581.192-1.052.483-1.413.873-.353.382-.53.905-.53 1.567 0 .906.335 1.59 1.005 2.054.677.456 1.534.684 2.572.684Zm13.492-8.257V106h-2.606V89.043h2.517v2.65h.221a4.843 4.843 0 0 1 1.81-2.075c.81-.53 1.855-.795 3.136-.795 1.148 0 2.152.235 3.013.706.861.464 1.531 1.17 2.01 2.12.478.942.717 2.134.717 3.576V106h-2.605V95.402c0-1.332-.346-2.37-1.038-3.113-.692-.75-1.641-1.126-2.848-1.126-.832 0-1.575.18-2.23.541-.648.36-1.159.887-1.534 1.579-.376.691-.563 1.53-.563 2.517Zm23.116 10.2h-2.871l8.302-22.609h2.826L195.863 106h-2.87l-6.757-19.032h-.176L179.304 106Zm1.059-8.832h11.57v2.43h-11.57v-2.43ZM198.141 106V83.391h2.605v8.346h.221c.191-.294.456-.67.795-1.126.346-.464.839-.876 1.479-1.236.648-.368 1.524-.552 2.627-.552 1.428 0 2.687.357 3.776 1.07 1.089.714 1.939 1.726 2.55 3.036.611 1.31.916 2.856.916 4.637 0 1.796-.305 3.352-.916 4.67-.611 1.31-1.457 2.325-2.539 3.046-1.082.714-2.329 1.071-3.742 1.071-1.09 0-1.962-.18-2.617-.541-.655-.368-1.159-.783-1.512-1.247a16.708 16.708 0 0 1-.817-1.17h-.309V106h-2.517Zm2.561-8.478c0 1.28.188 2.41.563 3.389.375.971.924 1.733 1.645 2.285.721.545 1.604.817 2.649.817 1.09 0 1.998-.287 2.727-.861.736-.582 1.288-1.362 1.656-2.341.375-.986.563-2.082.563-3.29 0-1.192-.184-2.266-.552-3.223-.361-.964-.909-1.726-1.645-2.285-.728-.567-1.645-.85-2.749-.85-1.059 0-1.95.269-2.671.806-.721.53-1.266 1.273-1.634 2.23-.368.95-.552 2.057-.552 3.323Zm15.15 8.478V89.043h2.517v2.562h.177c.309-.84.868-1.52 1.678-2.043.809-.522 1.722-.784 2.737-.784.192 0 .431.004.718.012.287.007.504.018.651.033v2.65a7.72 7.72 0 0 0-.607-.1 5.969 5.969 0 0 0-.982-.078c-.825 0-1.561.174-2.208.52a3.914 3.914 0 0 0-1.524 1.412c-.368.596-.552 1.277-.552 2.043V106h-2.605Zm15.313.397c-1.075 0-2.05-.202-2.926-.607a5.02 5.02 0 0 1-2.086-1.777c-.515-.78-.773-1.722-.773-2.826 0-.972.192-1.76.574-2.363a4.065 4.065 0 0 1 1.535-1.435 8.068 8.068 0 0 1 2.119-.772c.78-.177 1.564-.317 2.352-.42a101.66 101.66 0 0 1 2.506-.298c.647-.074 1.118-.195 1.413-.364.301-.17.452-.464.452-.883v-.089c0-1.089-.298-1.935-.894-2.539-.589-.603-1.483-.905-2.682-.905-1.244 0-2.219.272-2.926.817-.706.544-1.203 1.126-1.49 1.744l-2.473-.883c.442-1.03 1.03-1.833 1.766-2.407a6.624 6.624 0 0 1 2.429-1.214 10.08 10.08 0 0 1 2.605-.353c.545 0 1.17.066 1.877.198a6 6 0 0 1 2.064.784c.67.398 1.226.997 1.667 1.8.442.802.663 1.876.663 3.223V106h-2.606v-2.296h-.132c-.177.368-.471.762-.883 1.181-.412.42-.961.776-1.645 1.071-.685.294-1.52.441-2.506.441Zm.397-2.34c1.031 0 1.899-.202 2.606-.607.714-.405 1.251-.927 1.611-1.568.368-.64.552-1.313.552-2.02v-2.384c-.11.132-.353.254-.728.364-.368.103-.795.195-1.281.276-.478.074-.946.14-1.402.199-.449.051-.813.095-1.093.132a9.968 9.968 0 0 0-1.899.43c-.581.192-1.052.483-1.413.873-.353.382-.529.905-.529 1.567 0 .906.334 1.59 1.004 2.054.677.456 1.535.684 2.572.684ZM242.448 106V89.043h2.517v2.65h.221c.353-.905.924-1.608 1.711-2.109.788-.507 1.733-.761 2.837-.761 1.119 0 2.05.254 2.793.761.751.5 1.336 1.204 1.756 2.109h.176a4.94 4.94 0 0 1 1.954-2.087c.869-.522 1.91-.783 3.124-.783 1.516 0 2.757.474 3.721 1.424.964.942 1.446 2.41 1.446 4.404V106h-2.605V94.651c0-1.25-.343-2.145-1.027-2.682-.685-.537-1.49-.806-2.418-.806-1.192 0-2.116.36-2.771 1.082-.655.714-.982 1.619-.982 2.716V106h-2.65V94.386c0-.964-.312-1.74-.938-2.329-.626-.596-1.431-.894-2.418-.894-.677 0-1.31.18-1.898.541a4.074 4.074 0 0 0-1.413 1.501c-.354.633-.53 1.365-.53 2.197V106h-2.606Zm32.664.353c-1.53 0-2.873-.364-4.029-1.093-1.148-.728-2.046-1.748-2.694-3.058-.64-1.31-.96-2.84-.96-4.592 0-1.766.32-3.308.96-4.626.648-1.317 1.546-2.34 2.694-3.068 1.156-.729 2.499-1.093 4.029-1.093 1.531 0 2.871.364 4.019 1.093 1.155.728 2.053 1.751 2.693 3.069.648 1.317.972 2.859.972 4.625 0 1.752-.324 3.282-.972 4.592-.64 1.31-1.538 2.33-2.693 3.058-1.148.729-2.488 1.093-4.019 1.093Zm0-2.34c1.163 0 2.12-.298 2.871-.894.75-.596 1.306-1.38 1.667-2.352.36-.971.541-2.024.541-3.157a9.11 9.11 0 0 0-.541-3.168c-.361-.98-.917-1.77-1.667-2.374-.751-.603-1.708-.905-2.871-.905-1.162 0-2.119.302-2.87.905-.75.604-1.306 1.395-1.667 2.374a9.11 9.11 0 0 0-.541 3.168c0 1.133.181 2.186.541 3.157.361.972.917 1.756 1.667 2.352.751.596 1.708.894 2.87.894Zm23.676-14.97L292.517 106h-2.649l-6.271-16.957h2.827l4.68 13.513h.177l4.681-13.513h2.826Z"
							/>
						</svg>
					</div>
					<main tw="flex p-26 pb-32 relative z-10 flex-row w-full h-full grow items-end justify-between">
						<div
							tw={`${resource?.type === 'post' ? 'text-[62px]' : resource?.type === 'workshop' ? 'text-[42px]' : 'text-[56px]'} min-w-[500px] text-[#05118B] leading-tight pr-16`}
						>
							{title}
						</div>
						{image && resource && resource?.type !== 'post' && (
							<div tw={`flex items-start -mr-32 justify-start h-full`}>
								<div tw="relative flex items-center justify-center">
									<img src={image} width={700} />
									<div tw="absolute z-10 flex">
										<svg
											xmlns="http://www.w3.org/2000/svg"
											width={80}
											height={80}
											viewBox="0 0 12 12"
										>
											<g fill="#000">
												<path
													d="M11.741,5.562l-10-5.5a.5.5,0,0,0-.5.008A.5.5,0,0,0,1,.5v11a.5.5,0,0,0,.246.43A.491.491,0,0,0,1.5,12a.5.5,0,0,0,.241-.062l10-5.5a.5.5,0,0,0,0-.876Z"
													fill="#000"
												/>
											</g>
										</svg>
									</div>
								</div>
							</div>
						)}
					</main>
				</div>
			),
			{
				fonts: [
					{
						name: 'HeadingFont',
						data: fontData,
						style: 'normal',
					},
				],
				debug: false,
			},
		)
	} catch (e: any) {
		return new Response('Failed to generate OG image', { status: 500 })
	}
}
